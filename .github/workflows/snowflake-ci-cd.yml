name: snowflake-ci-cd

on:
  push:
    branches: [ main ]

jobs:
  deploy-to-snowflake:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI
        run: pip install "snowflake-cli-labs>=2.0.0"

      # NEW: define a temporary connection named "ci"
      - name: Configure Snowflake connection
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SNOWFLAKE_ACCOUNT }}   # e.g. xy12345.eu-central-1
          SNOWFLAKE_USER:      ${{ secrets.SNOWFLAKE_USER }}      # CI user bound to GIT_ADMIN
          SNOWFLAKE_PASSWORD:  ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          snow connection add ci \
            --temporary \
            --account "$SNOWFLAKE_ACCOUNT" \
            --user "$SNOWFLAKE_USER" \
            --password "$SNOWFLAKE_PASSWORD" \
            --role "GIT_ADMIN" \
            --warehouse "CI_WH"

      - name: Deploy to Snowflake
        run: |
          snow sql -c ci -q "
            ALTER GIT REPOSITORY DEVOPS_DB.INTEGRATION.SNOWFLAKE_DDL_REPO FETCH;

            EXECUTE IMMEDIATE FROM
              @DEVOPS_DB.INTEGRATION.SNOWFLAKE_DDL_REPO/branches/main/deploy/deploy_all.sql
            USING (
              DB_NAME     => 'MY_APP_DB',
              SCHEMA_NAME => 'PUBLIC'
            );
          "
