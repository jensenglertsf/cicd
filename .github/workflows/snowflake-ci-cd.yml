name: snowflake-ci-cd

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy-to-snowflake:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI
        run: pip install "snowflake-cli-labs>=3.0.0"

      # DEBUG: show which SNOWFLAKE_* env vars are present (values will be masked)
      - name: Debug Snowflake env
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER:      ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:  ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          echo "Listing SNOWFLAKE_* environment variables (values are masked by GitHub):"
          env | sort | grep '^SNOWFLAKE_' || echo "No SNOWFLAKE_* env vars found"

      # Optional: quick connectivity test using a temporary connection (-x)
      - name: Test Snowflake connection
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SNOWFLAKE_ACCOUNT }}   # e.g. xy12345.eu-central-1
          SNOWFLAKE_USER:      ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:  ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          export SNOWFLAKE_ACCOUNT="$SNOWFLAKE_ACCOUNT"
          export SNOWFLAKE_USER="$SNOWFLAKE_USER"
          export SNOWFLAKE_PASSWORD="$SNOWFLAKE_PASSWORD"
          export SNOWFLAKE_ROLE="GIT_ADMIN"
          export SNOWFLAKE_WAREHOUSE="COMPUTE_WH"

          snow connection test -x

      - name: Deploy to Snowflake
        env:
          SNOWFLAKE_ACCOUNT:   ${{ secrets.SNOWFLAKE_ACCOUNT }}   # e.g. xy12345.eu-central-1
          SNOWFLAKE_USER:      ${{ secrets.SNOWFLAKE_USER }}      # CI user bound to GIT_ADMIN
          SNOWFLAKE_PASSWORD:  ${{ secrets.SNOWFLAKE_PASSWORD }}
        run: |
          # Configure environment variables for the temporary connection
          export SNOWFLAKE_ACCOUNT="$SNOWFLAKE_ACCOUNT"
          export SNOWFLAKE_USER="$SNOWFLAKE_USER"
          export SNOWFLAKE_PASSWORD="$SNOWFLAKE_PASSWORD"
          export SNOWFLAKE_ROLE="GIT_ADMIN"
          export SNOWFLAKE_WAREHOUSE="COMPUTE_WH"

          # Use a temporary connection (-x) so no default/named connection is required
          snow sql -x -q "
            ALTER GIT REPOSITORY DEVOPS_DB.INTEGRATION.SNOWFLAKE_DDL_REPO FETCH;

            EXECUTE IMMEDIATE FROM
              @DEVOPS_DB.INTEGRATION.SNOWFLAKE_DDL_REPO/branches/main/deploy/deploy_all.sql
            USING (
              DB_NAME     => 'MY_APP_DB',
              SCHEMA_NAME => 'PUBLIC'
            );
          "
